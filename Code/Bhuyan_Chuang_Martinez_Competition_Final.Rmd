---
output: html_document
editor_options: 
  chunk_output_type: console
---

title: "Bhuyan_Chuang_Martinez_CompetitionReport_S25"
output: html_document
---

Github repository: https://github.com/jessalynlc/BhuyanChuangMartinez_ENV797_TSA_ForecastCompetition_S25

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	include = FALSE,
	tidy = FALSE,
	tidy.opts = list(width.cutoff = 80)
)
```

#Data Wrangling
```{r package, message=FALSE, warning=FALSE, include=FALSE}
library(lubridate)
library(ggplot2)
library(forecast)  
library(Kendall)
library(tseries)
library(outliers)
library(tidyverse)
library(smooth)
library(zoo)
library(kableExtra)
library(readxl)
library(xts)
```

#Data Import and Primary Cleaning
```{r Data Wrangling, include=FALSE}
#Importing time series data (relative humidity and temperature optional but importing)
#load data: this is daily data, with 24 different sensors
load_data <- read_excel(
  path = "./Data/load.xlsx",
  sheet = 1
)
sum(is.na(load_data))
sum(load_data == 0, na.rm = TRUE)

relative_humidity_data <- read_excel(
  path = "./Data/relative_humidity.xlsx",
  sheet = 1
)
sum(is.na(relative_humidity_data))
sum(relative_humidity_data == 0, na.rm = TRUE)

temperature_data <- read_excel(
  path = "./Data/temperature.xlsx",
  sheet = 1
)
sum(is.na(temperature_data))
sum(temperature_data == 0, na.rm = TRUE)
```

```{r include=FALSE}
load_processed <- load_data %>%
  pivot_longer(cols = starts_with("h"), names_to = "hour", values_to = "electricity_demand") %>%
  mutate(hour = as.integer(sub("h", "", hour)), date = ymd(date), year = year(date), 
         month = month(date), day = day(date)) %>% 
  select(date, year, month, day, hour, electricity_demand)

humidity_processed <- relative_humidity_data %>%
  pivot_longer(cols = starts_with("rh"), names_to = "hour", values_to = "relative_humidity") %>%
  mutate(hour = as.integer(gsub("[^0-9]", "", hour)), date = ymd(date), year = year(date), 
         month = month(date), day = day(date)) %>% 
  select(date, year, month, day, hour, relative_humidity)

temp_processed <- temperature_data %>%
  pivot_longer(cols = starts_with("t"), names_to = "hour", values_to = "temperature") %>%
  mutate(hour = as.integer(gsub("[^0-9]", "", hour)), date = ymd(date), year = year(date), 
         month = month(date), day = day(date)) %>% 
  select(date, year, month, day, hour, temperature)
```

## Converting to daily by taking averages
```{r include=FALSE}
daily_load <- load_processed %>%
  group_by(date) %>%
  summarise(daily_avg_load = mean(electricity_demand, na.rm = TRUE)) %>%
  ungroup()

daily_humidity <- humidity_processed %>%
  group_by(date) %>%
  summarise(daily_avg_humidity = mean(relative_humidity, na.rm = TRUE)) %>%
  ungroup()

daily_temp <- temp_processed %>%
  group_by(date) %>%
  summarise(daily_avg_temp = mean(temperature, na.rm = TRUE)) %>%
  ungroup()
```

## Merging the daily datasets to a full daily dataset 
```{r include=FALSE}
full_daily <- daily_load %>%
  inner_join(daily_temp, by = "date") %>%
  inner_join(daily_humidity, by = "date") %>%
  arrange(date)
head(full_daily)
```

##Converting to time series object
```{r message=FALSE, warning=FALSE}
ts_electricity_daily <- msts(full_daily$daily_avg_load, 
                              seasonal.periods = c(7, 365.25), 
                              start = decimal_date(as.Date("2005-01-01")))

autoplot(ts_electricity_daily) + ggtitle("Electricity Demand: Daily")

ts_daily_train <- window(ts_electricity_daily, end = c(2009, 365))
ts_daily_test  <- window(ts_electricity_daily, start = c(2010, 1), end = c(2010, 59))

autoplot(ts_daily_train) + ggtitle("Training Set: Daily Demand (2005-2009)")
autoplot(ts_daily_test) + ggtitle("Test Set: Daily Demand (Jan-Feb 2010)")
```


### Model 1: NNAR + Fourier (K = c(2,8)) on Train/Test Data
```{r nnar_fourier_k28, message=FALSE, warning=FALSE}
horizon <- length(ts_daily_test)

NN_fit_k28 <- nnetar(ts_daily_train,
                  p = 2,
                  P = 2,
                  xreg = fourier(ts_daily_train, K = c(2, 8)))

NN_for_k28 <- forecast(NN_fit_k28, h = horizon,
                       xreg = fourier(ts_daily_train, K = c(2, 8), h = horizon))

autoplot(ts_daily_train) +
   autolayer(NN_for_k28, series = "NNAR K=2,8", PI = FALSE) +
   ylab("Load")

accuracy(NN_for_k28, ts_daily_test)
```

### Model 2: NNAR + Fourier (K = c(2,12)) on Train/Test Data (Baseline)
```{r nnar_fourier_k212_baseline, message=FALSE, warning=FALSE}
NN_fit_k212_base <- nnetar(ts_daily_train,
                  p = 2,
                  P = 2,
                  xreg = fourier(ts_daily_train, K = c(2, 12)))

NN_for_k212_base <- forecast(NN_fit_k212_base, h = horizon,
                             xreg = fourier(ts_daily_train, K = c(2, 12), h = horizon))

autoplot(ts_daily_train) +
   autolayer(NN_for_k212_base, series = "NNAR K=2,12", PI = FALSE) +
   ylab("Load")

accuracy(NN_for_k212_base, ts_daily_test)
```

### Model 3: NNAR + Fourier (K = c(2,12)) on Train/Test Data
```{r nnar_fourier_k212, message=FALSE, warning=FALSE}
horizon <- length(ts_daily_test)
K <- c(2, 12)

xreg_train <- cbind(
  temp_train,
  fourier(ts_daily_train, K = K)
)
xreg_test <- cbind(
  temp_test,
  fourier(ts_daily_train, K = K, h = horizon)
)

NN_fit_k212 <- nnetar(
  ts_daily_train,
  p    = 2,
  P    = 2,
  xreg = xreg_train
)

NN_for_k212 <- forecast(
  NN_fit_k212,
  h    = horizon,
  xreg = xreg_test
)

autoplot(NN_for_k212) + ggtitle("NNAR + Fourier (K = c(2,12)) Forecast")
accuracy(NN_for_k212, ts_daily_test)
```

### Model 4: NNAR + Fourier (K = c(3,18)) on Train/Test Data
```{r nnar_fourier_k318_test, message=FALSE, warning=FALSE}
horizon <- length(ts_daily_test)
K <- c(3, 18)

xreg_train <- fourier(ts_daily_train, K = K)
xreg_test  <- fourier(ts_daily_train, K = K, h = horizon)

NN_fit_k318 <- nnetar(
  ts_daily_train,
  p    = 2,
  P    = 2,
  xreg = xreg_train,
  size = 10,
  decay = 0.01,
  maxNWts = 2000
)

NN_for_k318 <- forecast(
  NN_fit_k318,
  h    = horizon,
  xreg = xreg_test
)

autoplot(NN_for_k318) + ggtitle("Model 4: NNAR + Fourier (K = c(3,18)) Forecast on Test Data")
accuracy(NN_for_k318, ts_daily_test)
```


### Model 5: TBATS Model
```{r tbats_model, message=FALSE, warning=FALSE}
# Fit TBATS model (training data assumed to be ts_daily_train)
TBATS_fit <- tbats(ts_daily_train)

TBATS_for <- forecast(TBATS_fit, h = horizon)

# Forecast plot
autoplot(TBATS_for) +
  ggtitle("Model 5: TBATS Forecast") +
  ylab("Load")

# Overlay plot
autoplot(ts_daily_train) +
  autolayer(TBATS_for, series = "TBATS", PI = FALSE) +
  ylab("Load")

# Accuracy on test set
accuracy(TBATS_for, ts_daily_test)
```

### Model 6: ARIMA + NNAR Hybrid on Train/Test Data

```{r}
# Convert to univariate ts with daily frequency (e.g., yearly seasonality only)
# 1. Make sure your input is a plain ts object
ts_daily_train_ts <- ts(as.numeric(ts_daily_train), start = c(2005, 1), frequency = 365.25)

# 2. Fit plain ARIMA model
fit_arima <- auto.arima(ts_daily_train_ts, seasonal = TRUE)

# 3. Forecast ARIMA
fc_arima_test <- forecast(fit_arima, h = horizon)

# 4. Get ARIMA residuals
res_arima <- residuals(fit_arima)

# 5. Fit NNAR on residuals
fit_nnar_resid <- nnetar(res_arima)

# 6. Forecast residuals
fc_nnar_resid_test <- forecast(fit_nnar_resid, h = horizon)

# 7. Combine ARIMA + NNAR forecasts
fc_hybrid_test <- fc_arima_test$mean + fc_nnar_resid_test$mean





autoplot(ts_daily_test) +
  autolayer(fc_arima_test$mean, series = "ARIMA", PI = FALSE) +
  autolayer(fc_hybrid_test, series = "ARIMA + NNAR", PI = FALSE) +
  ggtitle("Model 6: ARIMA + NNAR Hybrid Forecast") +
  ylab("Load")


fc_hybrid_test <- fc_arima_test$mean + fc_nnar_resid_test$mean

# Convert hybrid forecast to a time series to match test set
fc_hybrid_ts <- ts(fc_hybrid_test, start = start(ts_daily_test), frequency = frequency(ts_daily_test))

# Compute accuracy
accuracy_hybrid <- accuracy(fc_hybrid_ts, ts_daily_test)
```


### Model Comparison: NNAR + Fourier + TBATS

```{r compare-nnar-models, message=FALSE, warning=FALSE}
comparison <- data.frame(
  Model = c(
    "Model 1: NNAR + Fourier (K=2,8)",
    "Model 2: NNAR + Fourier (K=2,12) Baseline",
    "Model 3: NNAR + Fourier (K=2,12) + Temp",
    "Model 4: NNAR + Fourier (K=3,18)",
    "Model 5: TBATS",
    "Model 6: ARIMA + NNAR Hybrid"
  ),
  RMSE = c(
    accuracy(NN_for_k28, ts_daily_test)[2, "RMSE"],
    accuracy(NN_for_k212_base, ts_daily_test)[2, "RMSE"],
    accuracy(NN_for_k212, ts_daily_test)[2, "RMSE"],
    accuracy(NN_for_k318, ts_daily_test)[2, "RMSE"],
    accuracy(TBATS_for, ts_daily_test)[2, "RMSE"],
    accuracy_hybrid["RMSE"]
  ),
  MAE = c(
    accuracy(NN_for_k28, ts_daily_test)[2, "MAE"],
    accuracy(NN_for_k212_base, ts_daily_test)[2, "MAE"],
    accuracy(NN_for_k212, ts_daily_test)[2, "MAE"],
    accuracy(NN_for_k318, ts_daily_test)[2, "MAE"],
    accuracy(TBATS_for, ts_daily_test)[2, "MAE"],
    accuracy_hybrid["MAE"]
  ),
  MAPE = c(
    accuracy(NN_for_k28, ts_daily_test)[2, "MAPE"],
    accuracy(NN_for_k212_base, ts_daily_test)[2, "MAPE"],
    accuracy(NN_for_k212, ts_daily_test)[2, "MAPE"],
    accuracy(NN_for_k318, ts_daily_test)[2, "MAPE"],
    accuracy(TBATS_for, ts_daily_test)[2, "MAPE"],
    accuracy_hybrid["MAPE"]
  )
)

kable(comparison, caption = "Performance Comparison of All Six Models Including ARIMA + NNAR Hybrid")



# comparison <- data.frame(
#   Model = c(
#     "Model 1: NNAR + Fourier (K=2,8)",
#     "Model 2: NNAR + Fourier (K=2,12) Baseline",
#     "Model 3: NNAR + Fourier (K=2,12) + Temp",
#     "Model 4: NNAR + Fourier (K=3,18)",
#     "Model 5: TBATS",
#     "Model 6: ARIMA + NNAR Hybrid"
#   ),
#   RMSE = c(
#     accuracy(NN_for_k28, ts_daily_test)[2, "RMSE"],
#     accuracy(NN_for_k212_base, ts_daily_test)[2, "RMSE"],
#     accuracy(NN_for_k212, ts_daily_test)[2, "RMSE"],
#     accuracy(NN_for_k318, ts_daily_test)[2, "RMSE"],
#     accuracy(TBATS_for, ts_daily_test)[2, "RMSE"],
#     accuracy_hybrid[2, "RMSE"]
#   ),
#   MAE = c(
#     accuracy(NN_for_k28, ts_daily_test)[2, "MAE"],
#     accuracy(NN_for_k212_base, ts_daily_test)[2, "MAE"],
#     accuracy(NN_for_k212, ts_daily_test)[2, "MAE"],
#     accuracy(NN_for_k318, ts_daily_test)[2, "MAE"],
#     accuracy(TBATS_for, ts_daily_test)[2, "MAE"],
#     accuracy_hybrid[2, "MAE"]
#   ),
#   MAPE = c(
#     accuracy(NN_for_k28, ts_daily_test)[2, "MAPE"],
#     accuracy(NN_for_k212_base, ts_daily_test)[2, "MAPE"],
#     accuracy(NN_for_k212, ts_daily_test)[2, "MAPE"],
#     accuracy(NN_for_k318, ts_daily_test)[2, "MAPE"],
#     accuracy(TBATS_for, ts_daily_test)[2, "MAPE"],
#     accuracy_hybrid[2, "MAPE"]
#   )
# )
# 
# kable(comparison, caption = "Performance Comparison of NNAR + Fourier and TBATS Models")
```

# Retraining and Forecasting on Full Data

## Model 3: NNAR + Fourier (K = c(2,12)) + Temp

```{r}
# Set K for Fourier
K3 <- c(2, 12)

# Create regressors: temperature + Fourier terms
xreg_full_3 <- cbind(full_daily$daily_avg_temp, fourier(ts_full, K = K3))

# Create forecast regressors: last 59 days of temp + Fourier terms for h = 59
xreg_fc_3 <- cbind(
  tail(full_daily$daily_avg_temp, final_n_for),
  fourier(ts_full, K = K3, h = final_n_for)
)

# Fit the NNAR model
fit_nnar_k212_temp <- nnetar(
  ts_full,
  p = 2,
  P = 2,
  xreg = xreg_full_3
)

# Forecast
fc_nnar_k212_temp <- forecast(
  fit_nnar_k212_temp,
  h = final_n_for,
  xreg = xreg_fc_3
)

# Create forecast dataframe
final_nnar_k212_temp_df <- data.frame(
  date = final_dates,
  load = as.numeric(fc_nnar_k212_temp$mean)
)

```

## Model 4: NNAR + Fourier (K = c(3,18))
```{r}
# Set K for Fourier
K4 <- c(3, 18)

# Create Fourier regressors
xreg_full_4 <- fourier(ts_full, K = K4)
xreg_fc_4   <- fourier(ts_full, K = K4, h = final_n_for)

# Fit the NNAR model with extended size and decay
fit_nnar_k318 <- nnetar(
  ts_full,
  p = 2,
  P = 2,
  xreg = xreg_full_4,
  size = 10,
  decay = 0.01,
  maxNWts = 2000
)

# Forecast
fc_nnar_k318 <- forecast(
  fit_nnar_k318,
  h = final_n_for,
  xreg = xreg_fc_4
)

# Create forecast dataframe
final_nnar_k318_df <- data.frame(
  date = final_dates,
  load = as.numeric(fc_nnar_k318$mean)
)

```

## Model 6: ARIMA + NNAR Hybrid

```{r}
# Step 1: Fit ARIMA on full data

# Convert msts to standard ts object
ts_full_simple <- ts(
  data = as.numeric(ts_full),
  start = c(2005, 1),
  frequency = 365.25
)

# Now fit ARIMA on this standard ts object
fit_arima_full <- auto.arima(ts_full_simple)


# Step 2: Get residuals and fit NNAR
res_arima_full <- residuals(fit_arima_full)
fit_nnar_resid_full <- nnetar(res_arima_full)

# Step 3: Forecast individually
fc_arima_final <- forecast(fit_arima_full, h = final_n_for)
fc_nnar_resid_final <- forecast(fit_nnar_resid_full, h = final_n_for)

# Step 4: Combine forecasts
fc_hybrid_final <- fc_arima_final$mean + fc_nnar_resid_final$mean

# Step 5: Save as dataframe
final_hybrid_df <- data.frame(
  date = final_dates,
  load = as.numeric(fc_hybrid_final)
)


```

# Exporting Dataset

```{r}
write.csv(final_nnar_k212_temp_df, "submission_nnar_k212_temp.csv", row.names = FALSE)
write.csv(final_nnar_k318_df, "submission_nnar_k318.csv", row.names = FALSE)
write.csv(final_hybrid_df, "submission_arima_nnar_hybrid.csv", row.names = FALSE)

```

